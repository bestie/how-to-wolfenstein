#!/usr/bin/env ruby

require_relative "../game/env"
require "io/console"

$log = File.open("log", "a")
$log.sync = true
$total_frames = 0

level = File.read("game/levels/level1.txt")

IO.console.raw do |io|
  map = Map.from_string(level)
  tracer = RayTracer.new
  renderer = ANSIRenderer.to_callable_with(tracer: tracer)

  game = Game.new(
    io: io,
    map: map,
    player: Player.new,
    renderer: renderer,
  )

  if ARGV.include?("--profile")
    require "ruby-prof"
    RubyProf.start
    game.start
    result = RubyProf.stop

    prof_log = File.open("profs/prof--#{io.winsize.join("x")}--#{$total_frames}-frames", "w")
    printer = RubyProf::FlatPrinter.new(result)
    printer.print(prof_log)
  else
    game.start
  end
end
